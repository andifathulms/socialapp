{% load static %}
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PNP Social Media</title>

    <link rel="stylesheet" href="{% static 'quixlab/css/style.css' %}">
    <!-- ALL PREVIOUS BASE.HTML STYLE -->
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    
    <!-- Cropperjs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.css" integrity="sha512-+VDbDxc9zesADd49pfvz7CgsOl2xREI/7gnzcdyA9XjuTxLXrdpuz21VVIqc5HPfZji2CypSbxx1lgD7BgBK5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'cropperjs/dist/cropper.min.css' %}">
    
    <!-- Material Icon -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">

    <!-- Sweet Alert, refactor later -->
    <link href="{% static 'quixlab/plugins/sweetalert/css/sweetalert.css' %}" rel="stylesheet">

    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <style type="text/css">
        :root {
             --primary-light: #8abdff;
             --primary: #6d5dfc;
             --primary-dark: #5b0eeb;
             --white: #fff;
             --greyLight-1: #e4ebf5;
             --greyLight-2: #c8d0e7;
             --greyLight-3: #bec8e4;
             --greyDark: #9baacf;
        }
        body{
            background:var(--greyLight-1) !important;
        }
    </style>
    {% include 'snippets/css/sidebar.css' %}
    {% block head %}{% endblock %}
</head>

<body>

    {% include 'snippets/preloader_sub.html' %}

    {% include 'snippets/base_js.html' %}

    <!-- Has to use visible overflow as a workaround position sticky -->
    <div id="main-wrapper" style="overflow: visible !important;">

        {% include 'snippets/header_2.html' %}
        
        
            <div class="container-fluid" id="main-content" style="padding-top: 7rem;">
                <div class="row">
                    <div class="col-md-2 m-0 p-0" style="position: -webkit-sticky;position: sticky;top: 100px;height: 100vh; ">
                        {% include 'snippets/sidebar_2.html' %}
                    </div>
                    
                    {% block content %}{% endblock %}
                    
                </div>
            </div>
        
        
        {% include 'snippets/footer.html' %}

    </div>
    
    {% include 'snippets/general_notifications.html' %}
    {% include 'snippets/chat_notifications.html' %}

    <!--**********************************
        Scripts
    ***********************************-->

    <script src="{% static 'quixlab/plugins/common/common.min.js' %}"></script>
    <script src="{% static 'quixlab/js/custom.min.js' %}"></script>
    <script src="{% static 'quixlab/js/settings.js' %}"></script>
    <script src="{% static 'quixlab/js/gleek.js' %}"></script>
    <script src="{% static 'quixlab/js/styleSwitcher.js' %}"></script>
    
    <!-- HTMX CDN -->
    <script src="https://unpkg.com/htmx.org@1.1.0"></script>
    <!-- handling CSRF request -->
    <script>
      document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
      })
    </script>

    <!-- jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js" integrity="sha512-WNLxfP/8cVYL9sj8Jnp6et0BkubLP31jhTG9vhL/F5uEZmg5wEzKoXp1kJslzPQWwPT1eyMiSxlKCgzHLOTOTQ==" crossorigin="anonymous"></script>

    <!-- cropperjs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js" integrity="sha512-ooSWpxJsiXe6t4+PPjCgYmVfr1NS5QXJACcR/FPpsdm6kqG1FmQ2SVyg2RXeVuCRBLr0lWHnWJP6Zs1Efvxzww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/11.0.1/markdown-it.min.js" integrity="sha512-hW0KbtvDnXCHbh2UCNP/6R+oXxCKiOfm9ciuUekdGBCQF1+57bGqZAk3sAFir7PMQstyRW0UecsSc2HQotH2vg==" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it-emoji/2.0.0/markdown-it-emoji.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/default.min.css" integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin="anonymous" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/kotlin.min.js" integrity="sha512-8aYTnyDstX39PHxorDD+6ROknf98Vqr5KTOjwRCl/442uAVKOpCJ5wY9I3VQ6y46rdDJKYBIglIfE2+GQk8U5Q==" crossorigin="anonymous"></script>

    <script>hljs.initHighlightingOnLoad();</script>

    <!-- Sweet Alert -->
    <script src="{% static 'quixlab/plugins/sweetalert/js/sweetalert.min.js' %}"></script>

    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        toastr.options = {
          "closeButton": false,
          "debug": false,
          "newestOnTop": true,
          "progressBar": true,
          "positionClass": "toast-bottom-center",
          "preventDuplicates": false,
          "onclick": null,
          "showDuration": "300",
          "hideDuration": "1000",
          "timeOut": "5000",
          "extendedTimeOut": "1000",
          "showEasing": "swing",
          "hideEasing": "linear",
          "showMethod": "fadeIn",
          "hideMethod": "fadeOut"
        }
    </script>

    <!-- Setup SOCKET for NOTIFICATIONS -->
    <!-- Originally from header.html -->
    <script type="text/javascript">
        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        //var ws_path = ws_scheme + '://' + window.location.host + ":8001/"; // PRODUCTION
        var ws_path = ws_scheme + '://' + window.location.host + "/";
        // console.log("Connecting to " + ws_path);
        var notificationSocket = new WebSocket(ws_path);

        // Handle incoming messages
        notificationSocket.onmessage = function(message) {
            var data = JSON.parse(message.data);
            console.log("Got notification websocket message. " + data.general_msg_type);

            /*
                GENERAL NOTIFICATIONS
            */
            // new 'general' notifications data payload
            if(data.general_msg_type == 0){
                handleGeneralNotificationsData(data['notifications'], data['new_page_number'])
            }

            // "General" Pagination exhausted. No more results.
            if(data.general_msg_type == 1){
                setGeneralPaginationExhausted()
            }

            // Refresh [newest_timestamp >= NOTIFICATIONS >= oldest_timestamp]
            if(data.general_msg_type == 2){
                refreshGeneralNotificationsData(data['notifications'])
            }

            if(data.general_msg_type == 3){
                handleNewGeneralNotificationsData(data['notifications'])
            }

            if(data.general_msg_type == 4){
                setUnreadGeneralNotificationsCount(data['count'])
            }

            if(data.general_msg_type == 5){
                updateGeneralNotificationDiv(data['notification'])
            }

            /*
            CHAT NOTIFICATIONS
            */
            // new 'chat' notifications data payload
            if(data.chat_msg_type == 10){
                handleChatNotificationsData(data['notifications'], data['new_page_number'])
            }
            // "Chat" Pagination exhausted. No more results.
            if(data.chat_msg_type == 11){
                setChatPaginationExhausted()
            }
            // refreshed chat notifications
            if(data.chat_msg_type == 13){
                handleNewChatNotificationsData(data['notifications'])
            }
            if(data.chat_msg_type == 14){
                setChatNotificationsCount(data['count'])
            }

        }

        notificationSocket.onclose = function(e) {
            console.error('Notification Socket closed unexpectedly');
        };

        notificationSocket.onopen = function(e){
            console.log("Notification Socket on open: " + e)
            setupGeneralNotificationsMenu()
            getFirstGeneralNotificationsPage()
            getUnreadGeneralNotificationsCount()

            setupChatNotificationsMenu()
            getFirstChatNotificationsPage()
        }

        notificationSocket.onerror = function(e){
            console.log('Notification Socket error', e)
        }

        if (notificationSocket.readyState == WebSocket.OPEN) {
            console.log("Notification Socket OPEN complete.")
        } 
        else if (notificationSocket.readyState == WebSocket.CONNECTING){
            console.log("Notification Socket connecting..")
        }
    </script>

    <script type="text/javascript">
        //setupChatDropdownHeader() remember this!!
        function executeQuery() {
            var query = ""
            //query = document.getElementById('id_q_small').value;
            query = document.getElementById('id_q_large').value;
            if (query == ""){
                query = document.getElementById('id_q_large').value;
            }
            window.location.replace("{% url 'search' %}?q=" + query)
            return false
        }

    </script>

    <script type="text/javascript">
        function formatTags() {
            const elements = document.getElementsByClassName('body-post');
            //const elements = document.querySelectorAll('.body-post');
            for (let i = 0; i < elements.length; i++) {
                let bodyText = elements[i].children[0].innerText;
                let words = bodyText.split(' ');
                for (let j = 0; j < words.length; j++) {
                    if (words[j][0] === '#') {
                        //let replacedText = bodyText.replace(/\s\#(.*?)(\s|$)/g, ` <a href="#">${words[j]}</a>`);
                        let replacedText = bodyText.replace(/\s\#(.*?)(\s|$)/g, ` <a href="/explore?query=${words[j].substring(1)}">${words[j]}</a>`);
                        elements[i].innerHTML = replacedText;

                        //console.log(replacedText);
                    }
                }
            }
        }

        formatTags();
    </script>
    <script>
        function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  const cookies = document.cookie.split(';');
                  for (let i = 0; i < cookies.length; i++) {
                      const cookie = cookies[i].trim();
                      // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) === (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
    </script>
    {% include 'snippets/js/sidebar.js' %}
    {% block javascript %}{% endblock %}

</body>

</html>